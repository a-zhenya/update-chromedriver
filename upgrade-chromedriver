#!/bin/sh

TMPDIR=/tmp
DIR_IF_NO_CURRENT="$HOME/.local/bin"
if [ ! -d "$DIR_IF_NO_CURRENT" ]; then
    DIR_IF_NO_CURRENT="$TMPDIR"
fi
LEAVE_ZIP_IF_NOT_SUCCESSFUL=y

# Get the latest version of chrome
version="$1"
if [ -z "$version" ]; then
    version=$(google-chrome --version | cut -d ' ' -f 3)
    version_source="installed google-chrome"
    dry=0
elif [ "$version" = "--apt" ]; then
    version=$(apt-get --just-print upgrade |
        grep "Conf google-chrome-stable" |
        grep -Eo '[[:digit:]]+\.[[:digit:]]+\.[[:digit:]]+\.[[:digit:]]+')
    if [ -z "$version" ]; then
        echo Cannot find the upgradable google-chrome-stable
        exit 0
    fi
    version_source="apt-cache"
    dry=yes
else
    version_source="command line"
    dry=yes
fi
echo chrome version=$version, $version_source

if which chromedriver; then
    driver_version=$(chromedriver --version | cut -d ' ' -f 2)
    if [ "$version" = "$driver_version" ]; then
        echo Already installed driver $driver_version
        exit 0
    else
        if [ "$dry" = yes ]; then
            echo Driver $driver_version. Checking if an update available
        else
            echo Current driver $driver_version. Replacing
        fi
    fi
fi

api="https://googlechromelabs.github.io/chrome-for-testing/known-good-versions-with-downloads.json"

# Get the url of corresponding chromedriver
url=$(
    curl -s "$api" |
    jq -r --arg VERSION "$version" '.versions[] | select(.version==$VERSION).downloads.chromedriver[] | select(.platform=="linux64").url'
)
echo url=$url

if [ -z "$url" ]; then
    echo "Could not find url for downloadable chromedriver"
    exit 1
fi

if [ "$dry" = yes ]; then
    echo "Found downloadable chromedriver $version"
    exit 0
fi

# Download chromedriver
ZIP_PATH=${TMPDIR}/chromedriver.zip
curl -sL -o "$ZIP_PATH" "$url"

if [ ! -f "$ZIP_PATH" ]; then
    echo "Could not download chromedriver"
    exit 1
fi

# Extract chromedriver
if which chromedriver; then
    target_dir=$(dirname $(which chromedriver))
else
    echo "Could not find CURRENT chromedriver binary"
    echo "New version will be put to $DIR_IF_NO_CURRENT/chromedriver"
    target_dir="$DIR_IF_NO_CURRENT"
fi
if unzip -d "$target_dir" -o -j "$ZIP_PATH" "*/chromedriver" ; then
    rm "$ZIP_PATH"
    ls -lh "$target_dir/chromedriver"
else
    if [ -z "$LEAVE_ZIP_IF_NOT_SUCCESSFUL" -o "$LEAVE_ZIP_IF_NOT_SUCCESSFUL" = 0 ]; then
    	echo Cannot unzip
	rm "$ZIP_PATH"
    else
    	echo Cannot unzip. Leaving the archive here: "$ZIP_PATH"
    fi
    exit 1
fi
